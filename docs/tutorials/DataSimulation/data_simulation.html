<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.3">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="W. Joel Schneider">
<meta name="dcterms.date" content="2025-02-25">
<meta name="description" content="W. Joel Schneider is a professor at Temple University.">

<title>W. Joel Schneider</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//images/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-81b5c3e63835cfde897ecd3d35a35a41.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-8324e2080287992c21ba0f6d539105a7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="W. Joel Schneider">
<meta property="og:description" content="Advanced Data Analysis (EDUC 8825)">
<meta property="og:image" content="https://wjschne.github.io/tutorials/DataSimulation/data_simulation_files/figure-html/fig-polished-1.png">
<meta property="og:site_name" content="W. Joel Schneider">
<meta property="og:image:height" content="1536">
<meta property="og:image:width" content="1536">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">W. Joel Schneider</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">R Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../assessingpsyche.html"> 
<span class="menu-text">Assessment Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../vita.html"> 
<span class="menu-text">Vita</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentations.html"> 
<span class="menu-text">Presentations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="mailto:schneider@temple.edu" rel="noreferrer noopener" target="_blank"> <i class="bi bi-envelope" role="img" aria-label="Email">
</i> 
<span class="menu-text">Email</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/wjschne" rel="noreferrer noopener" target="_blank"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text">GitHub</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Data Simulation for Multilevel Models</h1>
            <p class="subtitle lead">Advanced Data Analysis (EDUC 8825)</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>W. Joel Schneider </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 25, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#univariate-data" id="toc-univariate-data" class="nav-link active" data-scroll-target="#univariate-data">Univariate Data</a></li>
  <li><a href="#multivariate-data" id="toc-multivariate-data" class="nav-link" data-scroll-target="#multivariate-data">Multivariate Data</a>
  <ul class="collapse">
  <li><a href="#specify-means" id="toc-specify-means" class="nav-link" data-scroll-target="#specify-means">Specify Means</a></li>
  <li><a href="#specify-standard-deviations" id="toc-specify-standard-deviations" class="nav-link" data-scroll-target="#specify-standard-deviations">Specify Standard Deviations</a></li>
  <li><a href="#specify-the-correlation-matrix" id="toc-specify-the-correlation-matrix" class="nav-link" data-scroll-target="#specify-the-correlation-matrix">Specify the Correlation Matrix</a></li>
  <li><a href="#convert-correlation-matrix-to-covariance-matrix" id="toc-convert-correlation-matrix-to-covariance-matrix" class="nav-link" data-scroll-target="#convert-correlation-matrix-to-covariance-matrix">Convert Correlation Matrix to Covariance Matrix</a></li>
  <li><a href="#generate-multivariate-data" id="toc-generate-multivariate-data" class="nav-link" data-scroll-target="#generate-multivariate-data">Generate Multivariate Data</a></li>
  </ul></li>
  <li><a href="#generate-data-based-on-structural-model" id="toc-generate-data-based-on-structural-model" class="nav-link" data-scroll-target="#generate-data-based-on-structural-model">Generate Data Based on Structural Model</a></li>
  <li><a href="#multilevel-data" id="toc-multilevel-data" class="nav-link" data-scroll-target="#multilevel-data">Multilevel Data</a>
  <ul class="collapse">
  <li><a href="#step-1-write-out-your-equations" id="toc-step-1-write-out-your-equations" class="nav-link" data-scroll-target="#step-1-write-out-your-equations">Step 1: Write Out Your Equations</a></li>
  <li><a href="#step-2-specify-all-model-parameters" id="toc-step-2-specify-all-model-parameters" class="nav-link" data-scroll-target="#step-2-specify-all-model-parameters">Step 2: Specify all model parameters</a>
  <ul class="collapse">
  <li><a href="#specifying-the-fixed-coefficients" id="toc-specifying-the-fixed-coefficients" class="nav-link" data-scroll-target="#specifying-the-fixed-coefficients">Specifying the fixed coefficients</a></li>
  <li><a href="#specify-the-level-1-error-standard-deviation-or-variance" id="toc-specify-the-level-1-error-standard-deviation-or-variance" class="nav-link" data-scroll-target="#specify-the-level-1-error-standard-deviation-or-variance">Specify the level-1 error standard deviation (or variance)</a></li>
  <li><a href="#specify-tau_2-the-level-2-error-covariance-matrix" id="toc-specify-tau_2-the-level-2-error-covariance-matrix" class="nav-link" data-scroll-target="#specify-tau_2-the-level-2-error-covariance-matrix">Specify tau_2, the level-2 error covariance matrix</a></li>
  </ul></li>
  <li><a href="#step-2-simulate-the-level-2-variables." id="toc-step-2-simulate-the-level-2-variables." class="nav-link" data-scroll-target="#step-2-simulate-the-level-2-variables.">Step 2: Simulate the level-2 variables.</a>
  <ul class="collapse">
  <li><a href="#how-many-level-2-clusters-will-there-be" id="toc-how-many-level-2-clusters-will-there-be" class="nav-link" data-scroll-target="#how-many-level-2-clusters-will-there-be">How many level-2 clusters will there be?</a></li>
  <li><a href="#how-many-people-in-each-cluster" id="toc-how-many-people-in-each-cluster" class="nav-link" data-scroll-target="#how-many-people-in-each-cluster">How many people in each cluster?</a></li>
  <li><a href="#simulate-level-2-error-terms." id="toc-simulate-level-2-error-terms." class="nav-link" data-scroll-target="#simulate-level-2-error-terms.">Simulate level-2 error terms.</a></li>
  <li><a href="#simulate-level-2-predictors" id="toc-simulate-level-2-predictors" class="nav-link" data-scroll-target="#simulate-level-2-predictors">Simulate level-2 predictors</a></li>
  <li><a href="#compute-all-level-2-data-in-one-sequence-of-steps." id="toc-compute-all-level-2-data-in-one-sequence-of-steps." class="nav-link" data-scroll-target="#compute-all-level-2-data-in-one-sequence-of-steps.">Compute all level-2 data in one sequence of steps.</a></li>
  </ul></li>
  <li><a href="#step-3-simulate-level-1-data" id="toc-step-3-simulate-level-1-data" class="nav-link" data-scroll-target="#step-3-simulate-level-1-data">Step 3: Simulate Level-1 Data</a>
  <ul class="collapse">
  <li><a href="#convert-level-2-data-to-level-1-data" id="toc-convert-level-2-data-to-level-1-data" class="nav-link" data-scroll-target="#convert-level-2-data-to-level-1-data">Convert Level-2 Data to Level-1 Data</a></li>
  <li><a href="#compute-the-level-1-error-term-and-the-level-1-covariates." id="toc-compute-the-level-1-error-term-and-the-level-1-covariates." class="nav-link" data-scroll-target="#compute-the-level-1-error-term-and-the-level-1-covariates.">Compute the level-1 error term and the level-1 covariates.</a></li>
  </ul></li>
  <li><a href="#simulate-the-outcome-variable" id="toc-simulate-the-outcome-variable" class="nav-link" data-scroll-target="#simulate-the-outcome-variable">Simulate the outcome variable</a></li>
  </ul></li>
  <li><a href="#all-the-code-in-one-place" id="toc-all-the-code-in-one-place" class="nav-link" data-scroll-target="#all-the-code-in-one-place">All the code in one place</a></li>
  <li><a href="#model-the-data" id="toc-model-the-data" class="nav-link" data-scroll-target="#model-the-data">Model the data</a></li>
  <li><a href="#plot-the-data" id="toc-plot-the-data" class="nav-link" data-scroll-target="#plot-the-data">Plot the data</a></li>
  <li><a href="#simulation-packages" id="toc-simulation-packages" class="nav-link" data-scroll-target="#simulation-packages">Simulation packages</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p>Once you learn how to simulate data, you will possess a data-science superpower. Generating simulated data allows you to run complicated “What-If” thought experiments, which can help identify implications of models, methods, and procedures that are otherwise difficult to discern. For example, you can ask, if my hypothesized model is correct, what sample size will I need to detect my hypothesized results? Of course, this is what power analysis is for. However, there are many models for which no analytic solution exists, and only simulated data can generate approximate answers to your questions.</p>
<p>Simulated data can help you understand implicit implications of statistical procedures. For example, you might have heard that ANOVA is robust to mild to moderate violations of the normality assumption. How do we know this? Scholars simulated data with normal and non-normal residuals, and found that ANOVA generally came to the correct decision except when the normality assumption was violated to extreme degrees.</p>
<p>Simulated data can help you understand non-obvious implications of complex decisions. For example, Schneider &amp; Roman (2018) used simulated data to show that some well-intentioned diagnostic procedures cause diagnosis of learning disabilities to be less accurate, not more.</p>
<p>Simulated data have a primary limitation: they can only tell you about truths implicit in your model, method, or procedure. To observe genuinely new truths, you must observe genuinely new data.</p>
<section id="univariate-data" class="level1">
<h1>Univariate Data</h1>
<p>Sometimes we need to generate simulated data one variable at a time. Let’s generate 5 points from a normal distribution with a mean of 50 and a standard deviation of 10:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">5</span>, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 58.71856 49.46555 47.94691 62.39124 34.61092</code></pre>
</div>
</div>
<p>Of course, as long as the order of your parameters is what R expects, you can write this code more succinctly like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="dv">50</span>, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 45.33785 55.12266 64.42480 55.87030 68.25846</code></pre>
</div>
</div>
<p>Let’s generate many cases and see if the plot looks normal. We need to put the variable in a tibble because ggplot needs its input to be in a data.frame or tibble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">100000</span>, <span class="dv">50</span>, <span class="dv">10</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(x)) <span class="sc">+</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/ggplotdensity-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>That looks reasonably normal.</p>
</section>
<section id="multivariate-data" class="level1 page-columns page-full">
<h1>Multivariate Data</h1>
<p>Suppose that we need to generate three variables <em>x</em>, <em>y</em>, and <em>z</em> with means of 50, 75, and 80, and standard deviations of 5, 8 and 9. <em>x</em> and <em>y</em> correlate at 0.6, <em>x</em> and <em>z</em> correlate at 0.7, and <em>y</em> and <em>z</em> correlate at 0.8. The mvtnorm package can help us.</p>
<section id="specify-means" class="level2">
<h2 class="anchored" data-anchor-id="specify-means">Specify Means</h2>
<p>You already know how to set up a vector with the <code>c</code> function. We are going to create a named vector of means. That is, we are going to associate the mean values with their respective variable names. The reason we are doing this is that when we set the mean vector with names, the data generating function will automatically name the columns.</p>
<p>There are, of course, several ways to give vector elements names. Pick one that you like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Supply names directly. Does the job with the least typing.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">x =</span> <span class="dv">50</span>, <span class="at">y =</span> <span class="dv">75</span>, <span class="at">z =</span> <span class="dv">80</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the names function.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">80</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(m) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"z"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the names function after a pipe:</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">80</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">names&lt;-</span><span class="st">`</span>(<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"z"</span>))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> x  y  z 
50 75 80 </code></pre>
</div>
</div>
</section>
<section id="specify-standard-deviations" class="level2">
<h2 class="anchored" data-anchor-id="specify-standard-deviations">Specify Standard Deviations</h2>
<p>We set up the vector of standard deviations in the standard way, though you can apply names to it if you like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="specify-the-correlation-matrix" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="specify-the-correlation-matrix">Specify the Correlation Matrix</h2>
<p>The <code>matrix</code> function takes a vector, and you tell it how many rows and columns the matrix has. If you omit the number of columns, it will figure out how many columns are needed from the number of elements in your vector. In this case, there are 3 elements and 3 rows, so it divides 9 elements by 3 rows and assumes there are 3 columns.</p>
<p><span class="math display">\[\boldsymbol{R}=\left[\begin{array}{r} 1 &amp; .6 &amp; .7 \\ .6 &amp; 1 &amp; .8 \\ .7 &amp; .8 &amp; 1\end{array}\right]\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation matrix</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, .<span class="dv">6</span>, .<span class="dv">7</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>             .<span class="dv">6</span>,  <span class="dv">1</span>, .<span class="dv">8</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>             .<span class="dv">7</span>, .<span class="dv">8</span>,  <span class="dv">1</span>), </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]  1.0  0.6  0.7
[2,]  0.6  1.0  0.8
[3,]  0.7  0.8  1.0</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>In a <em>k</em>&nbsp;×&nbsp;<em>k</em> symmetric matrix, the number of redundant elements is</p>
<p><span class="math display">\[\frac{k(k-1)}{2}\]</span></p>
</div></div><p>With a 3&nbsp;×&nbsp;3 matrix, it is easy to specify a symmetric matrix because there are only 3 redundant entries. However, imagine how tedious specifying a 20&nbsp;×&nbsp;20 matrix with 190 redundant entries would be. With larger matrices, consider specifying just the lower triangle of the matrix, and converting it to a full symmetric matrix using lavaan’s <code>lower2full</code> function. I believe this approach is not only less tedious but also less error-prone.</p>
<p><span class="math display">\[\boldsymbol{R}_{\text{Lower}}=\left[\begin{array}{r} 1 &amp; \\ .6 &amp; 1 \\ .7 &amp; .8 &amp; 1\end{array}\right]\]</span></p>
<p>The input for lavaan’s <code>lav_matrix_lower2full</code> function is just a vector, but I put line breaks in it to mimic the configuration of the lower triangle of the matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> lavaan<span class="sc">::</span><span class="fu">lav_matrix_lower2full</span>(<span class="fu">c</span>(<span class="dv">1</span>,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                    .<span class="dv">6</span>,  <span class="dv">1</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                                    .<span class="dv">7</span>, .<span class="dv">8</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="convert-correlation-matrix-to-covariance-matrix" class="level2">
<h2 class="anchored" data-anchor-id="convert-correlation-matrix-to-covariance-matrix">Convert Correlation Matrix to Covariance Matrix</h2>
<p>The covariance of <em>x</em> and <em>y</em> (<em>σ<sub>xy</sub></em>) is the product of the correlation of <em>x</em> and <em>y</em> (<em>r<sub>xy</sub></em>) and the standard deviations of <em>x</em> and <em>y</em>.</p>
<p><span class="math display">\[\sigma_{xy}=r_{xy}\sigma_x\sigma_y\]</span></p>
<p>To convert a correlation matrix <em>R</em> into a covariance matrix <em>Σ</em> using just matrix algebra requires converting the standard deviations into a diagonal matrix <em>D</em> (i.e., standard deviations on the diagonal and zeroes everywhere else).</p>
<p><span class="math display">\[\boldsymbol{D}=\left[\begin{array}{l} \sigma_x&amp;0\\0&amp;\sigma_y \end{array}\right]\]</span></p>
<p><span class="math display">\[\boldsymbol{\Sigma = DRD}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using matrix operations:</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The diag function converts a vector to a diagonal matrix</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">diag</span>(s)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the correlation matrix to covariances</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The %*% function is the matrix multiplication operator</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">=</span> D <span class="sc">%*%</span> R <span class="sc">%*%</span> D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If this conversion process seems like a lot of work, lavaan’s <code>cor2cov</code> function is a quicker alternative:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">&lt;-</span> lavaan<span class="sc">::</span><span class="fu">cor2cov</span>(<span class="at">R =</span> R, <span class="at">sds =</span> s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generate-multivariate-data" class="level2">
<h2 class="anchored" data-anchor-id="generate-multivariate-data">Generate Multivariate Data</h2>
<p>Now we are ready to generate our multivariate normal data. Let’s generate 1000 cases. The <code>rmvnorm</code> function outputs a matrix, so we usually need to convert it to a tibble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> mvtnorm<span class="sc">::</span><span class="fu">rmvnorm</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">mean =</span> m, <span class="at">sigma =</span> Sigma) <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,000 × 3
       x     y     z
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1  38.0  61.5  58.8
 2  49.6  80.1  80.9
 3  43.8  73.3  70.2
 4  55.2  66.1  79.4
 5  47.9  67.2  81.3
 6  49.4  84.9  76.1
 7  52.0  77.6  81.6
 8  46.8  82.8  90.1
 9  48.1  73.9  78.8
10  40.0  58.9  53.5
# ℹ 990 more rows</code></pre>
</div>
</div>
<p>Let’s plot the simulated data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/displaypoint-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>If you want to add marginal density plots, ggExtra’s <code>ggMarginal</code> function looks nice to me.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we save a plot as a variable p</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(d, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal histograms will be added to our saved plot</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>ggExtra<span class="sc">::</span><span class="fu">ggMarginal</span>(p, <span class="at">data =</span> d, <span class="at">type =</span> <span class="st">"histogram"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/ggmarginal-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="generate-data-based-on-structural-model" class="level1 page-columns page-full">
<h1>Generate Data Based on Structural Model</h1>
<p>If you need to simulate data based on a model, the <code>simulateData</code> function from lavaan is quite good. The <a href="https://simsem.org/">simsem package</a> takes this approach to the next level, with excellent functions for power analysis.</p>
<p>If you think about things in terms of standardized path coefficients, my own package, <a href="https://wjschne.github.io/simstandard/articles/simstandard_tutorial.html">simstandard</a>, may be what you are looking for. The advantage of this package is that you do not need to know what the error variances need to be to make the path coefficients standardized.</p>
<p>For example, in this model, we know what path coefficients we want, but we do not know what the error variances should be:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://wjschne.github.io/simstandard/articles/ModelFigure.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Standardized Model</figcaption>
</figure>
</div>
<p>Using <a href="https://lavaan.ugent.be/tutorial/syntax1.html">lavaan syntax</a>, we can specify the model like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(simstandard)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># lavaan syntax for model</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="st">A =~ 0.7 * A1 + 0.8 * A2 + 0.9 * A3 + 0.3 * B1</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="st">B =~ 0.7 * B1 + 0.8 * B2 + 0.9 * B3</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="st">B ~ 0.6 * A</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate data</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">sim_standardized</span>(m, <span class="at">n =</span> <span class="dv">100000</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Display First 6 rows</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 15
       A1     A2     A3     B1       B2     B3       A      B   e_A1    e_A2
    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
1  0.155  -0.799  0.148 -0.865 -1.45    -0.955 -0.975  -1.32   0.837 -0.0190
2 -0.233   0.419 -0.434  0.499 -0.464    0.701 -0.0118  0.589 -0.225  0.428 
3 -0.981  -0.728 -0.625 -1.47  -2.66    -2.74  -0.801  -1.92  -0.420 -0.0870
4 -2.09   -2.52  -1.90  -1.66   0.00704 -1.34  -2.41   -1.01  -0.403 -0.595 
5 -0.0760  0.412  0.114  0.182 -0.960   -0.698  0.429  -0.475 -0.376  0.0691
6  0.171  -1.31  -0.529 -0.838 -0.244    0.285 -1.40   -0.608  1.15  -0.192 
# ℹ 5 more variables: e_A3 &lt;dbl&gt;, e_B1 &lt;dbl&gt;, e_B2 &lt;dbl&gt;, e_B3 &lt;dbl&gt;, d_B &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display complete model with variances</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">model_complete</span>(m))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
A =~ 0.7 * A1 + 0.8 * A2 + 0.9 * A3 + 0.3 * B1
B =~ 0.7 * B1 + 0.8 * B2 + 0.9 * B3
B ~ 0.6 * A

# Variances
A1 ~~ 0.51 * A1
A2 ~~ 0.36 * A2
A3 ~~ 0.19 * A3
B1 ~~ 0.168 * B1
B2 ~~ 0.36 * B2
B3 ~~ 0.19 * B3
A ~~ 1 * A
B ~~ 0.64 * B</code></pre>
</div>
</div>
<p>Let’s verify that the simulated data really has the right model. First we take the model and remove all the fixed coefficients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>m_free <span class="ot">&lt;-</span> <span class="fu">fixed2free</span>(m)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(m_free)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>B ~ A
A =~ A1 + A2 + A3 + B1
B =~ B1 + B2 + B3</code></pre>
</div>
</div>
<p>Now we use lavaan to evaluate the data with the <code>m_free</code> model. The simulated data has the latent variables in the data frame. We need to remove them before this can work:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lavaan)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>A, <span class="sc">-</span>B) <span class="sc">%&gt;%</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sem</span>(<span class="at">model =</span> m_free)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit, <span class="at">standardized =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6-19 ended normally after 27 iterations

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                        14

  Number of observations                        100000

Model Test User Model:
                                                      
  Test statistic                                13.110
  Degrees of freedom                                 7
  P-value (Chi-square)                           0.069

Parameter Estimates:

  Standard errors                             Standard
  Information                                 Expected
  Information saturated (h1) model          Structured

Latent Variables:
                   Estimate  Std.Err  z-value  P(&gt;|z|)   Std.lv  Std.all
  A =~                                                                  
    A1                1.000                               0.700    0.700
    A2                1.145    0.005  229.868    0.000    0.801    0.800
    A3                1.291    0.005  246.069    0.000    0.903    0.900
    B1                0.427    0.004  113.474    0.000    0.299    0.298
  B =~                                                                  
    B1                1.000                               0.702    0.701
    B2                1.141    0.005  238.328    0.000    0.801    0.801
    B3                1.285    0.005  247.303    0.000    0.902    0.900

Regressions:
                   Estimate  Std.Err  z-value  P(&gt;|z|)   Std.lv  Std.all
  B ~                                                                   
    A                 0.605    0.004  141.578    0.000    0.603    0.603

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)   Std.lv  Std.all
   .A1                0.509    0.003  194.880    0.000    0.509    0.510
   .A2                0.360    0.002  165.697    0.000    0.360    0.359
   .A3                0.190    0.002   97.808    0.000    0.190    0.189
   .B1                0.169    0.001  130.844    0.000    0.169    0.168
   .B2                0.359    0.002  178.355    0.000    0.359    0.359
   .B3                0.190    0.002  107.926    0.000    0.190    0.189
    A                 0.489    0.004  120.878    0.000    1.000    1.000
   .B                 0.313    0.003  123.981    0.000    0.636    0.636</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>semPlot<span class="sc">::</span><span class="fu">semPaths</span>(fit, <span class="at">what =</span> <span class="st">"std"</span>, <span class="at">layout =</span> <span class="st">"circle"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/evaluatefit-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>That looks like the model we specified.</p>
</section>
<section id="multilevel-data" class="level1 page-columns page-full">
<h1>Multilevel Data</h1>
<p>In generating multilevel data, we will use the techniques of generating both univariate and multivariate data.</p>
<section id="step-1-write-out-your-equations" class="level2">
<h2 class="anchored" data-anchor-id="step-1-write-out-your-equations">Step 1: Write Out Your Equations</h2>
<p>I cannot stress this point strongly enough. <strong>Taking the time to write your equations makes subsequent steps so much easier.</strong></p>
<p>Suppose we want to simulate data in which first-graders’ reading ability is predicted by their vocabulary measured at the beginning of the year and by their first grade teacher’s conscientiousness. Suppose that teacher conscientiousness is expected to help all students learn to read, but it is expected that teacher conscientiousness will be particularly important for students with low vocabulary. That is, the effect of teacher conscientiousness is expected to be stronger for students with low vocabulary compared to students with strong vocabulary. Thus, teacher conscientiousness will have an effect on vocabulary’s random slope.</p>
<p>So, we know that vocabulary is a level-1 variable, and teacher conscientiousness is a level-2 variable. Teacher conscientiousness is expected to have an effect on both the random intercept and vocabulary’s random slope.</p>
<p>Let’s write out the entire equations:</p>
<p><span class="math display">\[
\begin{align*}
\textbf{Level 1:}\\[1.5ex]
Reading_{ij}&amp;=b_{0j} + b_{1j}V_{ij}+e_{ij}\\
e&amp;\sim\mathcal{N}(0,\tau_1)\\[1.5ex]
\text{Where}\\
Reading_{ij}&amp;=\text{Reading score for student } i \text{ in class }  j\\
b_{0j} &amp;= \text{Random intercept for class } j\\
b_{1j} &amp;= \text{Random slope for Vocabulary for class } j\\
V_{ij}&amp;=\text{Vocabulary score for student } i \text{ in class }  j\\
e_{ij}&amp;=\text{Level-1 error for student } i \text{ in class }  j\\
\tau_1 &amp;= \text{Level-1 Error Variance}\\[2ex]
\textbf{Level 2:}\\[1.5ex]
b_{0j}&amp;=b_{00} + b_{01}C_{j}+e_{0j}\\
b_{1j}&amp;=b_{10} + b_{11}C_{j}+e_{1j}\\
\begin{bmatrix}e_{0j}\\e_{1j}\end{bmatrix}&amp;\sim\mathcal{N}\left(\begin{bmatrix}0\\ 0 \end{bmatrix}\begin{matrix} \\ ,\end{matrix}\begin{bmatrix}\tau_{00}&amp;\\ \tau_{10}&amp;\tau_{11}\end{bmatrix}\right)\\[1.5ex]
\text{Where}\\
b_{0j} &amp;= \text{Random intercept for class } j\\
b_{00} &amp;= \text{The expected intercept when } C_j \text{ is 0}\\
b_{01} &amp;= \text{The effect of } C_j \text{ on the random intercept}\\
C_j &amp;= \text{Teacher conscientiousness in class } j\\
e_{0j} &amp;= \text{The random intercept's error for class } j \\
b_{1j} &amp;= \text{Random slope for Vocabulary for class } j\\
b_{10} &amp;= \text{The expected Vocabulary slope when } C_j \text{ is 0}\\
b_{11} &amp;= \text{The effect of } C_j \text{ on the Vocabulary slope}\\
e_{1j} &amp;= \text{The Vocabulary slope's error for class } j \\
\tau_{00} &amp;= \text{The variance of } e_{0j}\\
\tau_{11} &amp;= \text{The variance of } e_{1j}\\
\tau_{10} &amp;= \text{The covariance of } e_{0j} \text{ and } e_{1j}
\end{align*}
\]</span></p>
<p>Combining the level-1 and level-2 formulas:</p>
<p><span class="math display">\[Reading_{ij}=\underbrace{b_{00} + b_{01}C_{j}+e_{0j}}_{b_{0j}} + (\underbrace{b_{10} + b_{11}C_{j}+e_{1j}}_{b_{1j}})V_{ij}+e_{ij}\]</span></p>
<p>By multiplying everything out, we can see exactly how everything needs to be calculated.</p>
<p><span class="math display">\[Reading_{ij}=b_{00} + b_{01}C_{j}+e_{0j} + b_{10}V_{ij} + b_{11}C_{j}V_{ij}+e_{1j}V_{ij}+e_{ij}\]</span></p>
<p>Now we are ready!</p>
</section>
<section id="step-2-specify-all-model-parameters" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="step-2-specify-all-model-parameters">Step 2: Specify all model parameters</h2>
<section id="specifying-the-fixed-coefficients" class="level3">
<h3 class="anchored" data-anchor-id="specifying-the-fixed-coefficients">Specifying the fixed coefficients</h3>
<p>In this case, we have four coefficients, and it is straightforward to specify them all.</p>
<p>Which values should you choose? That is determined by theory. With complex models like this one, sometimes there is a bit of trial-and-error to get parameter values that produce data that are consistent with the theory you have in mind.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed coefficients</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed intercept</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>b_00 <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Teacher conscientiousness effect on intercept</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>b_01 <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed slope for Vocabulary</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>b_10 <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Teacher conscientiousness effect on Vocabulary's slope</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>b_11 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="specify-the-level-1-error-standard-deviation-or-variance" class="level3">
<h3 class="anchored" data-anchor-id="specify-the-level-1-error-standard-deviation-or-variance">Specify the level-1 error standard deviation (or variance)</h3>
<p>You need to remember whether you set this number up as a variance or as a standard deviation. I am setting it up as a variance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Level-1 error variance</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>tau_1 <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="sc">^</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="specify-tau_2-the-level-2-error-covariance-matrix" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="specify-tau_2-the-level-2-error-covariance-matrix">Specify tau_2, the level-2 error covariance matrix</h3>
<p><span class="math display">\[\boldsymbol{\tau}_2=\begin{bmatrix}\tau_{00}&amp;\\ \tau_{10}&amp;\tau_{11}\end{bmatrix}\]</span></p>
<p>I have written out the <span class="math inline">\(\boldsymbol{\tau}_2\)</span> matrix showing only the lower triangle of the matrix because the upper triangle is redundant. I think it is safer to write the lower triangle rather than specifying the full matrix with its duplicate covariancs.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Specifying the full matrix would look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">matrix</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(tau_00, tau_10,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    tau_10, tau_11), </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div><p>We can create the <span class="math inline">\(\boldsymbol{\tau}_2\)</span> matrix like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance of intercepts</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>tau_00 <span class="ot">&lt;-</span> <span class="dv">25</span> <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance of Vocabulary slope</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>tau_11 <span class="ot">&lt;-</span> <span class="fl">0.4</span> <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation of intercepts and Vocabulary slopes</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>r_10 <span class="ot">&lt;-</span> <span class="sc">-</span>.<span class="dv">4</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariance of intercepts and slopes</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>tau_10 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(tau_00 <span class="sc">*</span> tau_11) <span class="sc">*</span> r_10</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># tau lower triangle in vector form</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>tau_lower_triangle <span class="ot">&lt;-</span> <span class="fu">c</span>(tau_00,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>                        tau_10, tau_11)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert lower triangle to a full symmetric matrix</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>tau_2 <span class="ot">&lt;-</span> lavaan<span class="sc">::</span><span class="fu">lav_matrix_lower2full</span>(tau_lower_triangle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-2-simulate-the-level-2-variables." class="level2">
<h2 class="anchored" data-anchor-id="step-2-simulate-the-level-2-variables.">Step 2: Simulate the level-2 variables.</h2>
<section id="how-many-level-2-clusters-will-there-be" class="level3">
<h3 class="anchored" data-anchor-id="how-many-level-2-clusters-will-there-be">How many level-2 clusters will there be?</h3>
<p>It is generally best to start with a small number so that you simulations will run quickly. You can increase the number of clusters later. Let’s start with 100 groups. We will use the variable <code>k</code> to refer to the number of clusters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of clusters</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cluster ID variable</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Makes a sequence from 1 to k</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>cluster_id <span class="ot">&lt;-</span> <span class="fu">seq</span>(k)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-many-people-in-each-cluster" class="level3">
<h3 class="anchored" data-anchor-id="how-many-people-in-each-cluster">How many people in each cluster?</h3>
<p><strong>Option 1</strong> Every cluster has the same size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Every class has 28 students</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>cluster_size <span class="ot">=</span> <span class="dv">28</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Option 2</strong> Cluster size is determined by a random variable.</p>
<p>Which random variable? It is up to you. Some common choices include the normal distribution, Poisson distribution, or the uniform distribution.</p>
<ol type="A">
<li><em>Use the normal distribution, and round to the nearest integer.</em> With small means and/or large standard deviations, there is a chance that you will have cluster sizes less than one, so you will want to plan for that. <br><br>To make sure we never have a cluster size less than 1, we will use the <code>pmax</code> function. It replaces any vector element less than the lower limit with the lower limit. For example:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pmax</span>(<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>), <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 1 1 4</code></pre>
</div>
</div>
<p>Here we generate a normal variate with a mean of 28 and a standard deviation of 2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>cluster_size <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(k, <span class="at">mean =</span> <span class="dv">28</span>, <span class="at">sd =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="at">digits =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmax</span>(<span class="dv">1</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(cluster_id, cluster_size)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d2, <span class="fu">aes</span>(cluster_size)) <span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/d2bar-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<ol start="2" type="A">
<li><em>Use the Poisson distribution to create integers with a mean (and variance) of λ.</em> With a small λ, it is possible to have cluster sizes of zero.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>cluster_size <span class="ot">=</span> <span class="fu">rpois</span>(k, <span class="at">lambda =</span> <span class="dv">28</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmax</span>(<span class="dv">1</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(cluster_id, cluster_size)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d2, <span class="fu">aes</span>(cluster_size)) <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/clustersized2-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>The binomial distribution is also a good choice for generating non-negative numbers.</p>
<ol start="3" type="A">
<li>Use the <code>sample</code> function to have cluster sizes uniformly distributed between 2 values.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>cluster_size <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">x =</span> <span class="dv">25</span><span class="sc">:</span><span class="dv">35</span>, <span class="at">size =</span> k, <span class="at">replace =</span> <span class="cn">TRUE</span>) </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(cluster_id, cluster_size)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d2, <span class="fu">aes</span>(cluster_size)) <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/sampleclustersize-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p><strong>Option 3</strong> Make your own distribution function.</p>
<ol type="A">
<li>If you know the probability of each member of your sample space, you can specify each probability in the <code>prob</code> argument in the <code>sample</code> function.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A tribble is a "transposed tibble" that is easy to view.</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># I pasted it directly from Excel using the datapasta RStudio addin</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>d_probs <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>sample_space, <span class="sc">~</span>probability,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>            <span class="dv">25</span>L,         <span class="fl">0.01</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>            <span class="dv">26</span>L,         <span class="fl">0.02</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>            <span class="dv">27</span>L,         <span class="fl">0.04</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>            <span class="dv">28</span>L,         <span class="fl">0.10</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>            <span class="dv">29</span>L,         <span class="fl">0.20</span>,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>            <span class="dv">30</span>L,         <span class="fl">0.30</span>,</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>            <span class="dv">31</span>L,         <span class="fl">0.20</span>,</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>            <span class="dv">32</span>L,         <span class="fl">0.08</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>            <span class="dv">33</span>L,         <span class="fl">0.03</span>,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>            <span class="dv">34</span>L,         <span class="fl">0.01</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>            <span class="dv">35</span>L,         <span class="fl">0.01</span>)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>cluster_size <span class="ot">=</span> <span class="fu">sample</span>(</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> d_probs<span class="sc">$</span>sample_space, </span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> d_probs<span class="sc">$</span>probability,</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> k, </span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">replace =</span> <span class="cn">TRUE</span>) </span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(cluster_id, cluster_size)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d2, <span class="fu">aes</span>(cluster_size)) <span class="sc">+</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/dprobs-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<ol start="2" type="A">
<li>If you have real data that you want to mimic, you can use the <code>sample</code> function to generate new data with the same proportions as the real data.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pretend that x is a vector with real data on class sizes. </span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Also pretend that we do not know how it was made. </span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># All we know is the data in x.</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>d_x <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">round</span>((<span class="fu">rpois</span>(<span class="dv">10000</span>, <span class="dv">28</span>) <span class="sc">-</span> <span class="dv">28</span>) <span class="sc">*</span> <span class="fl">0.3</span>, <span class="dv">0</span>) <span class="sc">+</span> <span class="dv">28</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(x) <span class="sc">%&gt;%</span> </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">probability =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="fu">nrow</span>(.))</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate new data based on same proportions</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>cluster_size <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">x =</span> d_x<span class="sc">$</span>x,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">size =</span> k,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">prob =</span> d_x<span class="sc">$</span>probability) <span class="sc">%&gt;%</span> </span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.integer</span>()</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(cluster_id, cluster_size)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d2, <span class="fu">aes</span>(cluster_size)) <span class="sc">+</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/dx-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="simulate-level-2-error-terms." class="level3">
<h3 class="anchored" data-anchor-id="simulate-level-2-error-terms.">Simulate level-2 error terms.</h3>
<p>We will use the <em>τ</em> matrix to simulate <em>u</em><sub>0<em>j</em></sub> and <em>u</em><sub>1<em>j</em></sub>.</p>
<p>Recall that</p>
<p><span class="math display">\[\begin{bmatrix}e_{0j}\\e_{1j}\end{bmatrix}\sim\mathcal{N}\left(\begin{bmatrix}0\\ 0 \end{bmatrix}\begin{matrix} \\ ,\end{matrix}\begin{bmatrix}\tau_{00}&amp;\\ \tau_{10}&amp;\tau_{11}\end{bmatrix}\right)\]</span></p>
<p>Create level-2 error terms.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(k, </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean =</span> <span class="fu">c</span>(<span class="at">e_0j =</span> <span class="dv">0</span>, <span class="at">e_1j =</span> <span class="dv">0</span>), </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">sigma =</span> tau_2) <span class="sc">%&gt;%</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>u</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 2
       e_0j    e_1j
      &lt;dbl&gt;   &lt;dbl&gt;
 1  25.0    -0.855 
 2 -27.3     0.539 
 3   0.194   0.120 
 4  57.3    -1.15  
 5 -46.0     0.0632
 6  -0.0923  0.210 
 7 -61.5     0.264 
 8 -17.4     0.625 
 9  52.0    -0.587 
10   8.15    0.0914
# ℹ 90 more rows</code></pre>
</div>
</div>
</section>
<section id="simulate-level-2-predictors" class="level3">
<h3 class="anchored" data-anchor-id="simulate-level-2-predictors">Simulate level-2 predictors</h3>
<p>How you simulate the level-2 predictors depends on theory. Personality variables like conscientiousness usually have a normal distribution. I am going to make things simple by creating a standard normal variate (mean = 0, sd = 1).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>C_j <span class="ot">=</span> <span class="fu">rnorm</span>(k)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compute-all-level-2-data-in-one-sequence-of-steps." class="level3">
<h3 class="anchored" data-anchor-id="compute-all-level-2-data-in-one-sequence-of-steps.">Compute all level-2 data in one sequence of steps.</h3>
<p>The <code>bind_cols</code> function binds the columns of two data.frames (or tibbles).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cluster_id =</span> <span class="dv">1</span><span class="sc">:</span>k,</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">cluster_size =</span> <span class="fu">rpois</span>(k, <span class="dv">28</span>) <span class="sc">%&gt;%</span> <span class="fu">pmax</span>(<span class="dv">1</span>),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">C_j =</span> <span class="fu">rnorm</span>(k)) <span class="sc">%&gt;%</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(u) <span class="sc">%&gt;%</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">b_0j =</span> b_00 <span class="sc">+</span> b_01 <span class="sc">*</span> C_j <span class="sc">+</span> e_0j,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">b_1j =</span> b_10 <span class="sc">+</span> b_11 <span class="sc">*</span> C_j <span class="sc">+</span> e_1j)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>d2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 100 × 7
   cluster_id cluster_size    C_j     e_0j    e_1j  b_0j  b_1j
        &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1          1           25  0.226  25.0    -0.855   530.  28.2
 2          2           26 -0.831 -27.3     0.539   456.  33.9
 3          3           45 -0.354   0.194   0.120   493.  31.5
 4          4           21 -0.351  57.3    -1.15    550.  30.3
 5          5           29 -0.301 -46.0     0.0632  448.  31.3
 6          6           31 -1.32   -0.0923  0.210   474.  35.5
 7          7           19 -0.760 -61.5     0.264   423.  33.3
 8          8           16  1.36  -17.4     0.625   510.  25.2
 9          9           33 -0.401  52.0    -0.587   544.  31.0
10         10           31 -0.237   8.15    0.0914  503.  31.0
# ℹ 90 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="step-3-simulate-level-1-data" class="level2">
<h2 class="anchored" data-anchor-id="step-3-simulate-level-1-data">Step 3: Simulate Level-1 Data</h2>
<section id="convert-level-2-data-to-level-1-data" class="level3">
<h3 class="anchored" data-anchor-id="convert-level-2-data-to-level-1-data">Convert Level-2 Data to Level-1 Data</h3>
<p>The <code>uncount</code> function makes this step easy. It duplicates a row the number of times specified in the weights variable—the cluster size in this case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> d2 <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">uncount</span>(cluster_size)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>d1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,832 × 6
   cluster_id   C_j  e_0j   e_1j  b_0j  b_1j
        &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1          1 0.226  25.0 -0.855  530.  28.2
 2          1 0.226  25.0 -0.855  530.  28.2
 3          1 0.226  25.0 -0.855  530.  28.2
 4          1 0.226  25.0 -0.855  530.  28.2
 5          1 0.226  25.0 -0.855  530.  28.2
 6          1 0.226  25.0 -0.855  530.  28.2
 7          1 0.226  25.0 -0.855  530.  28.2
 8          1 0.226  25.0 -0.855  530.  28.2
 9          1 0.226  25.0 -0.855  530.  28.2
10          1 0.226  25.0 -0.855  530.  28.2
# ℹ 2,822 more rows</code></pre>
</div>
</div>
</section>
<section id="compute-the-level-1-error-term-and-the-level-1-covariates." class="level3">
<h3 class="anchored" data-anchor-id="compute-the-level-1-error-term-and-the-level-1-covariates.">Compute the level-1 error term and the level-1 covariates.</h3>
<p>The <code>rnorm</code> function needs to know how many rows there are. Because the number of rows was generated randomly, we do not usually know how many rows there will be. Fortunately, we can use the <code>nrow</code> function, which tells us how many rows are in a data frame. The dot in the phrase <code>nrow(.)</code> the data.frame that was piped into the <code>mutate</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> d1 <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">V_ij =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(.)),</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">e =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(.), <span class="at">sd =</span> <span class="fu">sqrt</span>(tau_1)))</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>d1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,832 × 8
   cluster_id   C_j  e_0j   e_1j  b_0j  b_1j    V_ij     e
        &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
 1          1 0.226  25.0 -0.855  530.  28.2 -0.0953  2.06
 2          1 0.226  25.0 -0.855  530.  28.2 -0.0774  4.52
 3          1 0.226  25.0 -0.855  530.  28.2 -0.0243  6.34
 4          1 0.226  25.0 -0.855  530.  28.2 -0.120   2.93
 5          1 0.226  25.0 -0.855  530.  28.2 -0.675   4.16
 6          1 0.226  25.0 -0.855  530.  28.2  0.0480 -8.11
 7          1 0.226  25.0 -0.855  530.  28.2 -0.669   6.06
 8          1 0.226  25.0 -0.855  530.  28.2 -1.20   12.8 
 9          1 0.226  25.0 -0.855  530.  28.2 -1.55   -5.43
10          1 0.226  25.0 -0.855  530.  28.2  1.26   -1.82
# ℹ 2,822 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="simulate-the-outcome-variable" class="level2">
<h2 class="anchored" data-anchor-id="simulate-the-outcome-variable">Simulate the outcome variable</h2>
<p>If we have written out the level-1 equation, this step is easy.</p>
<p><span class="math display">\[Reading_{ij}=b_{0j} + b_{1j}V_{ij}+e_{ij}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> d1 <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Reading =</span> b_0j <span class="sc">+</span> b_1j <span class="sc">*</span> V_ij <span class="sc">+</span> e)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>d1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,832 × 9
   cluster_id   C_j  e_0j   e_1j  b_0j  b_1j    V_ij     e Reading
        &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1          1 0.226  25.0 -0.855  530.  28.2 -0.0953  2.06    529.
 2          1 0.226  25.0 -0.855  530.  28.2 -0.0774  4.52    532.
 3          1 0.226  25.0 -0.855  530.  28.2 -0.0243  6.34    535.
 4          1 0.226  25.0 -0.855  530.  28.2 -0.120   2.93    529.
 5          1 0.226  25.0 -0.855  530.  28.2 -0.675   4.16    515.
 6          1 0.226  25.0 -0.855  530.  28.2  0.0480 -8.11    523.
 7          1 0.226  25.0 -0.855  530.  28.2 -0.669   6.06    517.
 8          1 0.226  25.0 -0.855  530.  28.2 -1.20   12.8     508.
 9          1 0.226  25.0 -0.855  530.  28.2 -1.55   -5.43    480.
10          1 0.226  25.0 -0.855  530.  28.2  1.26   -1.82    563.
# ℹ 2,822 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="all-the-code-in-one-place" class="level1">
<h1>All the code in one place</h1>
<p>In the context of this tutorial, it might seem like the number of steps was really, really long. It is not actually all that bad. Let’s see what things look like put together:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">9</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, mvtnorm, lavaan, lme4)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of clusters</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed coefficients</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed intercept</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>b_00 <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Teacher conscientiousness effect on intercept</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>b_01 <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed slope for Vocabulary</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>b_10 <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Teacher conscientiousness effect on Vocabulary's slope</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>b_11 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">4</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Level-1 error standard deviation</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>tau_1 <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Random variances</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance of intercepts</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>tau_00 <span class="ot">&lt;-</span> <span class="dv">25</span> <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance of Vocabulary slope</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>tau_11 <span class="ot">&lt;-</span> <span class="fl">0.4</span> <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation of intercepts and Vocabulary slopes</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>r_10 <span class="ot">&lt;-</span> <span class="sc">-</span>.<span class="dv">4</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariance of intercepts and Vocabulary slopes</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>tau_10 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(tau_00 <span class="sc">*</span> tau_11) <span class="sc">*</span> r_10</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Level-2 covariance matrix</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>tau_2 <span class="ot">&lt;-</span> <span class="fu">lav_matrix_lower2full</span>(<span class="fu">c</span>(tau_00,</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>                               tau_10, tau_11))</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Level-2 error terms</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(k, </span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean =</span> <span class="fu">c</span>(<span class="at">e_0j =</span> <span class="dv">0</span>, <span class="at">e_1j =</span> <span class="dv">0</span>), </span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">sigma =</span> tau_2) <span class="sc">%&gt;%</span> </span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cluster_id =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span>k),</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">cluster_size =</span> <span class="fu">rpois</span>(k, <span class="dv">28</span>) <span class="sc">%&gt;%</span> <span class="fu">pmax</span>(<span class="dv">1</span>),</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>            <span class="at">C_j =</span> <span class="fu">rnorm</span>(k)) <span class="sc">%&gt;%</span> </span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(u) <span class="sc">%&gt;%</span> </span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">b_0j =</span> b_00 <span class="sc">+</span> b_01 <span class="sc">*</span> C_j <span class="sc">+</span> e_0j,</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">b_1j =</span> b_10 <span class="sc">+</span> b_11 <span class="sc">*</span> C_j <span class="sc">+</span> e_1j) <span class="sc">%&gt;%</span> </span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">uncount</span>(cluster_size) <span class="sc">%&gt;%</span> </span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">V_ij =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(.)), </span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">e =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(.), <span class="at">sd =</span> <span class="fu">sqrt</span>(tau_1)),</span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>         <span class="at">Reading =</span> b_0j <span class="sc">+</span> b_1j <span class="sc">*</span> V_ij <span class="sc">+</span> e,</span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>         <span class="at">cluster_id =</span> <span class="fu">fct_reorder</span>(cluster_id, C_j))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-the-data" class="level1">
<h1>Model the data</h1>
<p>Let’s see what our simulated data look like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final model</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Reading <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> C_j <span class="sc">*</span> V_ij <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> V_ij <span class="sc">|</span> cluster_id), <span class="at">data =</span> d)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: Reading ~ 1 + C_j * V_ij + (1 + V_ij | cluster_id)
   Data: d

REML criterion at convergence: 59808.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.7672 -0.6602  0.0046  0.6449  3.3959 

Random effects:
 Groups     Name        Variance  Std.Dev. Corr 
 cluster_id (Intercept)  574.5203 23.9692       
            V_ij           0.4954  0.7038  -1.00
 Residual               2511.8457 50.1183       
Number of obs: 5571, groups:  cluster_id, 200

Fixed effects:
            Estimate Std. Error t value
(Intercept) 501.3340     1.8740 267.527
C_j          20.9674     1.7940  11.687
V_ij         29.6150     0.7018  42.199
C_j:V_ij     -3.7965     0.6615  -5.739

Correlation of Fixed Effects:
         (Intr) C_j    V_ij  
C_j       0.222              
V_ij     -0.072 -0.010       
C_j:V_ij -0.010 -0.079  0.214
optimizer (nloptwrap) convergence code: 0 (OK)
boundary (singular) fit: see help('isSingular')</code></pre>
</div>
</div>
<p>We see that our fixed effect and random variance estimates are reasonably close to our population parameters.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fncvndvyhh" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#fncvndvyhh table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#fncvndvyhh thead, #fncvndvyhh tbody, #fncvndvyhh tfoot, #fncvndvyhh tr, #fncvndvyhh td, #fncvndvyhh th {
  border-style: none;
}

#fncvndvyhh p {
  margin: 0;
  padding: 0;
}

#fncvndvyhh .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#fncvndvyhh .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#fncvndvyhh .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#fncvndvyhh .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#fncvndvyhh .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fncvndvyhh .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fncvndvyhh .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fncvndvyhh .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#fncvndvyhh .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#fncvndvyhh .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#fncvndvyhh .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#fncvndvyhh .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#fncvndvyhh .gt_spanner_row {
  border-bottom-style: hidden;
}

#fncvndvyhh .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#fncvndvyhh .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#fncvndvyhh .gt_from_md > :first-child {
  margin-top: 0;
}

#fncvndvyhh .gt_from_md > :last-child {
  margin-bottom: 0;
}

#fncvndvyhh .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#fncvndvyhh .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#fncvndvyhh .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#fncvndvyhh .gt_row_group_first td {
  border-top-width: 2px;
}

#fncvndvyhh .gt_row_group_first th {
  border-top-width: 2px;
}

#fncvndvyhh .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fncvndvyhh .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#fncvndvyhh .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#fncvndvyhh .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fncvndvyhh .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fncvndvyhh .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#fncvndvyhh .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#fncvndvyhh .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#fncvndvyhh .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fncvndvyhh .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fncvndvyhh .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fncvndvyhh .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fncvndvyhh .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fncvndvyhh .gt_left {
  text-align: left;
}

#fncvndvyhh .gt_center {
  text-align: center;
}

#fncvndvyhh .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#fncvndvyhh .gt_font_normal {
  font-weight: normal;
}

#fncvndvyhh .gt_font_bold {
  font-weight: bold;
}

#fncvndvyhh .gt_font_italic {
  font-style: italic;
}

#fncvndvyhh .gt_super {
  font-size: 65%;
}

#fncvndvyhh .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#fncvndvyhh .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#fncvndvyhh .gt_indent_1 {
  text-indent: 5px;
}

#fncvndvyhh .gt_indent_2 {
  text-indent: 10px;
}

#fncvndvyhh .gt_indent_3 {
  text-indent: 15px;
}

#fncvndvyhh .gt_indent_4 {
  text-indent: 20px;
}

#fncvndvyhh .gt_indent_5 {
  text-indent: 25px;
}

#fncvndvyhh .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#fncvndvyhh div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="Effect" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Effect</th>
<th id="Parameter" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Parameter</th>
<th id="Estimate" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Estimate</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Effect">(b_{00})</td>
<td class="gt_row gt_right" headers="Parameter">500</td>
<td class="gt_row gt_right" headers="Estimate">501.33</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Effect">(b_{01})</td>
<td class="gt_row gt_right" headers="Parameter">20</td>
<td class="gt_row gt_right" headers="Estimate">20.97</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Effect">(b_{10})</td>
<td class="gt_row gt_right" headers="Parameter">30</td>
<td class="gt_row gt_right" headers="Estimate">29.61</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Effect">(b_{11})</td>
<td class="gt_row gt_right" headers="Parameter">-4</td>
<td class="gt_row gt_right" headers="Estimate">−3.80</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Effect">(_{00})</td>
<td class="gt_row gt_right" headers="Parameter">625</td>
<td class="gt_row gt_right" headers="Estimate">574.52</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Effect">(_{10})</td>
<td class="gt_row gt_right" headers="Parameter">-4</td>
<td class="gt_row gt_right" headers="Estimate">−16.87</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Effect">(_{11})</td>
<td class="gt_row gt_right" headers="Parameter">0.16</td>
<td class="gt_row gt_right" headers="Estimate">0.50</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Not bad. The variance components look a bit off. I am not showing the results here, but when I increased the level 1 and level 2 sample sizes to much larger values, the tau matrix approximated the correct values. The model took a looooooong time to run. However, it was worth the wait because I now have confidence that the data are being generated correctly.</p>
</section>
<section id="plot-the-data" class="level1 page-columns page-full">
<h1>Plot the data</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>sjPlot<span class="sc">::</span><span class="fu">plot_model</span>(fit, </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">type =</span> <span class="st">"pred"</span>, </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">terms =</span> <span class="fu">c</span>(<span class="st">"V_ij"</span>, <span class="st">"C_j"</span>)) <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Vocabulary"</span>, </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Teacher</span><span class="sc">\n</span><span class="st">Conscientiousness"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="data_simulation_files/figure-html/plotmodel-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Alternately, make the plot yourself</p>
<div class="cell preview-image page-columns page-full">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>d_augmented <span class="ot">&lt;-</span> broom.mixed<span class="sc">::</span><span class="fu">augment</span>(fit)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make fitted values for conditional slopes</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>d_conditional_slope_v <span class="ot">&lt;-</span> broom.mixed<span class="sc">::</span><span class="fu">augment</span>(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  fit, </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">crossing</span>(<span class="at">C_j =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>, </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">V_ij =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>),</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cluster_id =</span> <span class="fu">factor</span>(<span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Reading =</span> .fitted)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_augmented, <span class="fu">aes</span>(V_ij, Reading)) <span class="sc">+</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> d_conditional_slope_v, <span class="fu">aes</span>(<span class="at">group =</span> C_j, <span class="at">color =</span> C_j)) <span class="sc">+</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> C_j)) <span class="sc">+</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Vocabulary"</span>, <span class="at">color =</span> <span class="st">"Teacher</span><span class="sc">\n</span><span class="st">Conscientiousness"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<div id="fig-polished" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-polished-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="data_simulation_files/figure-html/fig-polished-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-polished-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Effect of Vocabulary on Reading by Teacher Conscientiousness
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="simulation-packages" class="level1">
<h1>Simulation packages</h1>
<p>There are many R packages for simulating multilevel data. I recommend checking out <a href="https://github.com/pitakakariki/simr">simr</a> and <a href="https://kgoldfeld.github.io/simstudy/">simstudy</a>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/wjschne\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>